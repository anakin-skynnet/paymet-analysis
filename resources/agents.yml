# =============================================================================
# Step 6: Deploy Agents (Orchestrator & Specialists)
# =============================================================================
# Task 1 (run_agent_framework): Custom Python framework (agent_framework.py) â€” orchestrator
# + Smart Routing, Smart Retry, Decline Analyst, Risk Assessor, Performance Recommender.
# Same notebook used by the app's Orchestrator chat (Path 3 fallback); output is read by Jobs API.
# Task 2 (register_responses_agent): Register the ResponsesAgent (agent.py) to UC and deploy
# to Model Serving as "payment-response-agent". This is the primary AI Chat backend (Path 1).
# =============================================================================

resources:
  jobs:
    "job_6_deploy_agents":
      name: "[${var.environment}] 6. Deploy Agents (Orchestrator & Specialists)"
      description: "Task 1: run agent framework (Path 3 fallback). Task 2: register ResponsesAgent (payment-response-agent, Path 1 primary)."
      max_concurrent_runs: 1
      environments:
        - environment_key: lakebase_sdk
          spec:
            environment_version: "4"
            dependencies:
              - "databricks-sdk==0.88.0"
              - "databricks-langchain==0.15.0"
              - "unitycatalog-langchain[databricks]==0.3.0"
              - "langgraph==1.0.8"
              - "langchain-core==1.2.12"
              - "mlflow==3.9.0"
              - "psycopg[binary]==3.3.2"
        - environment_key: responses_agent
          spec:
            environment_version: "4"
            dependencies:
              - "databricks-sdk==0.88.0"
              - "databricks-openai==0.10.0"
              - "unitycatalog-ai[databricks]==0.3.2"
              - "backoff==2.2.1"
              - "mlflow==3.9.0"
      tasks:
        - task_key: run_agent_framework
          description: "Run agent framework (orchestrator + all specialists); output used by app Orchestrator chat (Path 3)"
          environment_key: lakebase_sdk
          notebook_task:
            notebook_path: ${workspace.root_path}/src/payment_analysis/agents/agent_framework
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              llm_endpoint: ${var.llm_endpoint_orchestrator}
              specialist_llm_endpoint: ${var.llm_endpoint_specialist}
              query: "Run comprehensive payment analysis: routing, retries, declines, risk, and performance optimizations."
              agent_role: "orchestrator"
          timeout_seconds: 3600
          max_retries: 2
        - task_key: register_responses_agent
          description: "Register ResponsesAgent (agent.py) to UC and deploy to payment-response-agent endpoint"
          environment_key: responses_agent
          notebook_task:
            notebook_path: ${workspace.root_path}/src/payment_analysis/agents/register_responses_agent
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              model_registry_schema: "agents"
              llm_endpoint: ${var.llm_endpoint_specialist}
          timeout_seconds: 1800
          max_retries: 2
      schedule:
        quartz_cron_expression: "0 0 7 ? * MON"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      tags:
        environment: ${var.environment}
        project: payment-analysis
        component: ai-agents
        step: "6"
        domain: payment-analytics
