# =============================================================================
# Step 6: Deploy AgentBricks agents (unified)
# =============================================================================
# Single task runs the full agent framework: Orchestrator + all specialists
# (Smart Routing, Smart Retry, Decline Analyst, Risk Assessor, Performance Recommender).
# One notebook run builds the framework and executes one comprehensive query;
# the orchestrator routes to the appropriate specialists and synthesizes the response.
# Approval rules from OLTP Lakebase Autoscaling when lakebase_* params are set.
# =============================================================================

resources:
  jobs:
    "job_6_deploy_agents":
      name: "[${var.environment}] 6. Deploy AgentBricks Agents (Orchestrator & Specialists)"
      description: "Run the payment analysis agent framework: orchestrator coordinates Smart Routing, Smart Retry, Decline Analyst, Risk Assessor, and Performance Recommender. Single task runs one comprehensive analysis. Approval rules from Lakebase when configured."
      max_concurrent_runs: 1
      environments:
        - environment_key: lakebase_sdk
          spec:
            environment_version: "4"
            dependencies:
              - "databricks-sdk==0.84.0"
              - "psycopg[binary]==3.2.3"
      tasks:
        - task_key: run_agent_framework
          description: "Run full agent framework (orchestrator + all specialists) with one comprehensive query"
          environment_key: lakebase_sdk
          notebook_task:
            notebook_path: ${workspace.root_path}/src/payment_analysis/agents/agent_framework
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              lakebase_project_id: ${var.lakebase_project_id}
              lakebase_branch_id: ${var.lakebase_branch_id}
              lakebase_endpoint_id: ${var.lakebase_endpoint_id}
              lakebase_schema: "payment_analysis"
              query: "Run comprehensive payment analysis: routing, retries, declines, risk, and performance optimizations."
          timeout_seconds: 3600
      schedule:
        quartz_cron_expression: "0 0 7 ? * MON"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      tags:
        environment: ${var.environment}
        project: payment-analysis
        component: ai-agents
        step: "6"
        domain: payment-analytics
