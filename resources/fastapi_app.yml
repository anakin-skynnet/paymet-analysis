# Databricks App resource: name, source path, and resource bindings.
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Full configuration (when deployed + UI steps):
#   User authorization scopes (below): sql, dashboards.genie, files.files, serving.serving-endpoints,
#     vectorsearch.vector-search-indexes, catalog.connections, catalog.catalogs:read, catalog.schemas:read, catalog.tables:read.
#   App resources from bundle: SQL warehouse, Secret, UC volume, Jobs 1–7, Serving endpoints (4).
#   Genie: uncomment genie-space block and set --var genie_space_id=<uuid> then redeploy.
#   Add in Apps UI (Configure → App resources → + Add resource) after deploy: Database (Lakebase),
#     MLflow experiment, Vector search index, UC function, UC connection.
#
# Prerequisites: Secret scope "payment-analysis" with key "api-key" in workspace; volume and warehouse from bundle.
# Environment (Workspace → Apps → payment-analysis → Edit → Environment):
#   LAKEBASE_* — Required. DATABRICKS_WAREHOUSE_ID — Required (from sql-warehouse binding).
#   DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET — Injected for the app's service principal.

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: Payment Approval Optimization Platform – dashboards, rules, decisioning, ML models, and agent jobs.
      # User authorization scopes (Users must consent; required for OBO access). See Apps UI → Configure → User authorization.
      user_api_scopes:
        - sql
        - dashboards.genie
        - files.files
        - serving.serving-endpoints
        - vectorsearch.vector-search-indexes
        - catalog.connections
        - catalog.catalogs:read
        - catalog.schemas:read
        - catalog.tables:read
      resources:
        # SQL warehouse — analytics, app_config, gold views
        - name: sql-warehouse
          description: SQL warehouse for analytics, app_config, gold views
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE
        # Secret — API keys or sensitive config (create scope "payment-analysis" and key in workspace)
        - name: app-secrets
          description: Secret scope for API keys or other sensitive config
          secret:
            scope: "payment-analysis"
            key: "api-key"
            permission: READ
        # Genie space — uncomment and set --var genie_space_id=<uuid> when you have a Genie space (empty space_id causes app update to fail)
        # - name: genie-space
        #   description: Genie space for natural language analytics (Ask Data)
        #   genie_space:
        #     name: "Approvals domain expert"
        #     space_id: ${var.genie_space_id}
        #     permission: CAN_RUN
        # UC volume — reports and exports (volume created in unity_catalog.yml)
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME
        # Jobs used by UI (Setup & Run). Order: 1 Data Repos → 2 Simulator → 3 Ingestion → 4 Dashboards → 5 ML → 6 Agents → 7 Genie.
        - name: job-1-data-repositories
          description: "1. Create Data Repositories (Lakehouse, Vector Search, Lakebase)"
          job:
            id: ${resources.jobs.job_1_create_data_repositories.id}
            permission: CAN_MANAGE_RUN
        - name: job-2-simulator
          description: "2. Simulate Transaction Events"
          job:
            id: ${resources.jobs.job_2_simulate_transaction_events.id}
            permission: CAN_MANAGE_RUN
        - name: job-3-ingestion
          description: "3. Initialize Ingestion (Gold Views)"
          job:
            id: ${resources.jobs.job_3_initialize_ingestion.id}
            permission: CAN_MANAGE_RUN
        - name: job-4-dashboards
          description: "4. Deploy Dashboards (Prepare & Publish)"
          job:
            id: ${resources.jobs.job_4_deploy_dashboards.id}
            permission: CAN_MANAGE_RUN
        - name: job-5-train-ml
          description: "5. Train Models and Serving"
          job:
            id: ${resources.jobs.job_5_train_models_and_serving.id}
            permission: CAN_MANAGE_RUN
        - name: job-6-agents
          description: "6. Deploy Agents (AgentBricks)"
          job:
            id: ${resources.jobs.job_6_deploy_agents.id}
            permission: CAN_MANAGE_RUN
        - name: job-7-genie
          description: "7. Genie Space Sync"
          job:
            id: ${resources.jobs.job_7_genie_sync.id}
            permission: CAN_MANAGE_RUN
        # Model serving — include resources/model_serving.yml in databricks.yml and run Step 5 (Train ML) first
        - name: serving-approval-prop
          description: Approval propensity model endpoint
          serving_endpoint:
            name: "approval-propensity-${var.environment}"
            permission: CAN_QUERY
        - name: serving-risk-scoring
          description: Risk scoring model endpoint
          serving_endpoint:
            name: "risk-scoring-${var.environment}"
            permission: CAN_QUERY
        - name: serving-smart-routing
          description: Smart routing model endpoint
          serving_endpoint:
            name: "smart-routing-${var.environment}"
            permission: CAN_QUERY
        - name: serving-smart-retry
          description: Smart retry model endpoint
          serving_endpoint:
            name: "smart-retry-${var.environment}"
            permission: CAN_QUERY
        # -------------------------------------------------------------------------
        # Full config: add these in Apps UI (Compute → Apps → payment-analysis → Edit → Configure → App resources → + Add resource).
        # Bundle YAML does not support these resource types yet; add after deploy to see them in the portal.
        # -------------------------------------------------------------------------
        # • Database (Lakebase): select instance + database → Can connect and create
        # • MLflow experiment: select experiment → Can read
        # • Vector search index: select index (e.g. <catalog>.<schema>.similar_transactions_index) → Can select
        # • UC function: select function (e.g. catalog.schema.get_decline_trends) → Can execute
        # • UC connection: select connection → Use connection
      # Lakebase: app also uses LAKEBASE_PROJECT_ID, LAKEBASE_BRANCH_ID, LAKEBASE_ENDPOINT_ID (set in app Environment).
