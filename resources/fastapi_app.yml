# Databricks App resource: name, source path, and resource bindings.
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Full configuration: User authorization scopes (below) + App resources listed. Set --var genie_space_id=<uuid> for Genie when deploying.
#
# SERVING ENDPOINTS: All 7 endpoints are included below (4 ML models + 3 agents).
#   If a deploy fails with "Endpoint with name '...' does not exist", run Job 5 (ML models) and
#   Job 6 (agents) first so the endpoints exist, then redeploy.
#   Option B (manual): Add endpoints in Workspace → Apps → payment-analysis → Configure → App resources.
#   For orchestrator chat: ORCHESTRATOR_SERVING_ENDPOINT is set in app.yml (project root).
#
# Note: experiments, vector_search_index, and UC functions are not supported as app resource types
# by the bundle schema. Add them manually in Workspace → Apps → payment-analysis → Configure → App resources if needed.
# App env: defined in app.yml at project root (env section). LAKEBASE_*, PYTHONPATH, ORCHESTRATOR_SERVING_ENDPOINT.
# Platform-injected: DATABRICKS_WAREHOUSE_ID (from sql-warehouse binding), DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET.

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: Payment Approval Optimization Platform – dashboards, rules, decisioning, ML models, and agent jobs.
      # User authorization scopes (Users must consent; required for OBO access). See Apps UI → Configure → User authorization.
      # User authorization scopes — only include scopes supported by the workspace OAuth system.
      # Invalid scopes cause "error while trying to authenticate" at login.
      # See: https://docs.databricks.com/en/dev-tools/databricks-apps/auth.html
      user_api_scopes:
        - sql
        - serving.serving-endpoints
        - dashboards.genie
      resources:
        # SQL warehouse — [dev] Payment Analysis Warehouse
        - name: sql-warehouse
          description: SQL warehouse for analytics, app_config, gold views
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE
        # UC volume — /Volumes/ahs_demos_catalog/payment_analysis/reports
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME
        # Genie space — Payment Analytics (requires pre-existing Genie space).
        # Uncomment after creating the space in the target workspace and setting:
        #   --var genie_space_id=<your-genie-space-uuid>
        # - name: genie-space
        #   description: Genie space Payment Analytics
        #   genie_space:
        #     name: "Payment Analytics"
        #     space_id: ${var.genie_space_id}
        #     permission: CAN_EDIT
        # Model serving — all 7 endpoints (4 ML models + 3 agents: 2 LangGraph + 1 ResponsesAgent).
        # Agent endpoints use ResponsesAgent (MLflow 3.x); see model_serving.yml.
        # Orchestrator chat falls back to Job 6 if the serving endpoint is unavailable.
        # Agent endpoints are created by Job 6. Uncomment after running Job 6:
        # - name: serving-orchestrator
        #   serving_endpoint: { name: "payment-analysis-orchestrator", permission: CAN_QUERY }
        # - name: serving-response-agent
        #   serving_endpoint: { name: "payment-response-agent", permission: CAN_QUERY }
        # - name: serving-decline-analyst
        #   serving_endpoint: { name: "decline-analyst", permission: CAN_QUERY }
        - name: serving-approval-prop
          serving_endpoint: { name: "approval-propensity", permission: CAN_QUERY }
        - name: serving-risk-scoring
          serving_endpoint: { name: "risk-scoring", permission: CAN_QUERY }
        - name: serving-smart-routing
          serving_endpoint: { name: "smart-routing", permission: CAN_QUERY }
        - name: serving-smart-retry
          serving_endpoint: { name: "smart-retry", permission: CAN_QUERY }
        # Lakeflow jobs — app backend uses ws.jobs.list/run_now/get_run for Setup & Run and Orchestrator chat.
        # All 7 jobs need CAN_MANAGE_RUN so the app can trigger and poll them.
        - name: job-1-create-data-repos
          description: "Job 1: Create Data Repositories (Lakehouse, Vector Search, Lakebase)"
          job:
            id: ${resources.jobs.job_1_create_data_repositories.id}
            permission: CAN_MANAGE_RUN
        - name: job-2-simulate-events
          description: "Job 2: Simulate Transaction Events (Streaming)"
          job:
            id: ${resources.jobs.job_2_simulate_transaction_events.id}
            permission: CAN_MANAGE_RUN
        - name: job-3-initialize-ingestion
          description: "Job 3: Initialize Ingestion (UC tools, data init)"
          job:
            id: ${resources.jobs.job_3_initialize_ingestion.id}
            permission: CAN_MANAGE_RUN
        - name: job-4-deploy-dashboards
          description: "Job 4: Deploy Dashboards (prepare + publish)"
          job:
            id: ${resources.jobs.job_4_deploy_dashboards.id}
            permission: CAN_MANAGE_RUN
        - name: job-5-train-models
          description: "Job 5: Train ML Models and Publish to Serving"
          job:
            id: ${resources.jobs.job_5_train_models_and_serving.id}
            permission: CAN_MANAGE_RUN
        - name: job-6-deploy-agents
          description: "Job 6: Deploy Agents (Orchestrator + Specialists, ResponsesAgent)"
          job:
            id: ${resources.jobs.job_6_deploy_agents.id}
            permission: CAN_MANAGE_RUN
        - name: job-7-genie-sync
          description: "Job 7: Genie Space Sync"
          job:
            id: ${resources.jobs.job_7_genie_sync.id}
            permission: CAN_MANAGE_RUN
        # ------------------------------------------------------------------------------------------
        # Pipelines: The backend uses ws.pipelines.list_pipelines() and ws.pipelines.start_update()
        # for pipelines 8 & 9 from the Setup & Run page. However, **pipelines are NOT a supported
        # Databricks Apps resource type**. To grant access:
        #   1. In Workspace → Pipelines → [pipeline] → Permissions, add the app's service principal
        #      (payment-analysis) with "Can Manage Run" permission. OR
        #   2. In the pipeline permissions section of pipelines.yml (DAB), add the app SP.
        # Pipeline IDs:
        #   8. ETL: ${resources.pipelines.payment_analysis_etl.id}
        #   9. Real-Time Stream: ${resources.pipelines.payment_realtime_pipeline.id}
        # ------------------------------------------------------------------------------------------
        # Optional: legacy/external LLM endpoint (uncomment if used)
        # - name: serving-endpoint
        #   description: External model endpoint
        #   serving_endpoint:
        #     name: "mas-b6e74e87-endpoint"
        #     permission: CAN_QUERY
        # --- Not supported by bundle schema; add in Workspace → Apps → Configure → App resources if needed ---
        # MLflow experiments (IDs are workspace-specific; add manually after deploy)
        # Vector search index: ${var.catalog}.${var.schema}.similar_transactions_index
        # UC functions: ${var.catalog}.${var.schema}.<function_name> (agent tools from Job 3)
