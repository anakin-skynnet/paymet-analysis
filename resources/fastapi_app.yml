# Databricks App resource: name, source path, and resource bindings.
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Full configuration: User authorization scopes (below) + App resources listed. Set --var genie_space_id=<uuid> for Genie when deploying.
#
# WHY SERVING ENDPOINTS ARE COMMENTED OUT:
#   The bundle deploy fails with "Endpoint with name '...' does not exist" if the app is bound to a serving endpoint that
#   does not yet exist in the workspace. We comment them out so the app can deploy; you then either (1) create the
#   endpoints and uncomment below, or (2) add the endpoints in Workspace → Apps → payment-analysis → Edit → Configure → App resources.
#
# HOW TO LINK SERVICE ENDPOINTS WITH THE APP:
#   Use two-phase deploy so endpoints exist before the app is bound: run ./scripts/deploy_with_dependencies.sh [dev|prod].
#   It deploys jobs first (phase 1), runs Job 5 and Job 6 to completion, then deploys model serving + app (phase 2).
#   Option B (manual): Add endpoints in Workspace → Apps → payment-analysis → Configure → App resources.
#   For orchestrator chat: set Environment variable ORCHESTRATOR_SERVING_ENDPOINT=payment-analysis-orchestrator.
#
# Note: Bundle may warn on experiment, vector_search_index, function. If app update fails on those, add in Apps UI.
# Environment (Workspace → Apps → payment-analysis → Edit → Environment):
#   LAKEBASE_* — Required. DATABRICKS_WAREHOUSE_ID — Required (from sql-warehouse binding).
#   DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET — Injected for the app's service principal.

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: Payment Approval Optimization Platform – dashboards, rules, decisioning, ML models, and agent jobs.
      # User authorization scopes (Users must consent; required for OBO access). See Apps UI → Configure → User authorization.
      user_api_scopes:
        - sql
        - dashboards.genie
        - files.files
        - serving.serving-endpoints
        - vectorsearch.vector-search-indexes
        - catalog.connections
        - catalog.catalogs:read
        - catalog.schemas:read
        - catalog.tables:read
      resources:
        # SQL warehouse — [dev] Payment Analysis Warehouse
        - name: sql-warehouse
          description: SQL warehouse for analytics, app_config, gold views
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE
        # UC volume — /Volumes/ahs_demos_catalog/payment_analysis/reports
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME
        # Genie space — Payment Analytics (space_id default in databricks.yml)
        - name: genie-space
          description: Genie space Payment Analytics
          genie_space:
            name: "Payment Analytics"
            space_id: ${var.genie_space_id}
            permission: CAN_EDIT
        # Model serving — endpoints created by model_serving.yml after Job 5 & 6. Use two-phase deploy (deploy_with_dependencies.sh) so jobs run before app.
        - name: serving-orchestrator
          description: AgentBricks/Supervisor orchestrator (set ORCHESTRATOR_SERVING_ENDPOINT=payment-analysis-orchestrator to use)
          serving_endpoint:
            name: "payment-analysis-orchestrator"
            permission: CAN_QUERY
        - name: serving-decline-analyst
          description: Decline analyst agent (LangGraph)
          serving_endpoint:
            name: "decline-analyst-${var.environment}"
            permission: CAN_QUERY
        - name: serving-approval-prop
          description: Approval propensity model
          serving_endpoint:
            name: "approval-propensity-${var.environment}"
            permission: CAN_QUERY
        - name: serving-risk-scoring
          description: Risk scoring model
          serving_endpoint:
            name: "risk-scoring-${var.environment}"
            permission: CAN_QUERY
        - name: serving-smart-routing
          description: Smart routing model
          serving_endpoint:
            name: "smart-routing-${var.environment}"
            permission: CAN_QUERY
        - name: serving-smart-retry
          description: Smart retry model
          serving_endpoint:
            name: "smart-retry-${var.environment}"
            permission: CAN_QUERY
        # Optional: legacy/external LLM endpoint (uncomment if used)
        # - name: serving-endpoint
        #   description: External model endpoint
        #   serving_endpoint:
        #     name: "mas-b6e74e87-endpoint"
        #     permission: CAN_QUERY
        # --- Not supported by bundle schema yet; add in Workspace → Apps → payment-analysis → Configure → App resources ---
        # MLflow experiments
        # - name: experiment
        #   description: MLflow experiment
        #   experiment:
        #     experiment_id: "276177355410657"
        #     permission: CAN_EDIT
        # - name: experiment-2
        #   description: MLflow experiment 2
        #   experiment:
        #     experiment_id: "276177355500503"
        #     permission: CAN_EDIT
        # Vector search index
        # - name: vector-search-index
        #   description: Similar transactions vector search index
        #   vector_search_index:
        #     index_name: "ahs_demos_catalog.payment_analysis.similar_transactions_index"
        #     permission: CAN_SELECT
        # UC functions (agent tools)
        # - name: function
        #   description: get_cascade_recommendations
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_cascade_recommendations"
        #     permission: CAN_EXECUTE
        # - name: function-2
        #   description: get_decline_by_segment
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_decline_by_segment"
        #     permission: CAN_EXECUTE
        # - name: function-3
        #   description: get_decline_trends
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_decline_trends"
        #     permission: CAN_EXECUTE
        # - name: function-4
        #   description: get_high_risk_transactions
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_high_risk_transactions"
        #     permission: CAN_EXECUTE
        # - name: function-5
        #   description: get_kpi_summary
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_kpi_summary"
        #     permission: CAN_EXECUTE
        # - name: function-6
        #   description: get_optimization_opportunities
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_optimization_opportunities"
        #     permission: CAN_EXECUTE
        # - name: function-7
        #   description: get_recovery_opportunities
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_recovery_opportunities"
        #     permission: CAN_EXECUTE
        # - name: function-8
        #   description: get_retry_success_rates
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_retry_success_rates"
        #     permission: CAN_EXECUTE
        # - name: function-9
        #   description: get_risk_distribution
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_risk_distribution"
        #     permission: CAN_EXECUTE
        # - name: function-10
        #   description: get_route_performance
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_route_performance"
        #     permission: CAN_EXECUTE
        # - name: function-11
        #   description: get_trend_analysis
        #   function:
        #     function_name: "ahs_demos_catalog.payment_analysis.get_trend_analysis"
        #     permission: CAN_EXECUTE
