# =============================================================================
# Databricks App Resource: Payment Analysis Platform
# =============================================================================
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Two identity models:
#   1. APP AUTHORIZATION (service principal)
#      - Injected automatically: DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET
#      - Used for: Lakebase (managed Postgres), background tasks, app_config, session management
#      - The SP needs: Postgres role in Lakebase, UC permissions on catalog/schema
#
#   2. USER AUTHORIZATION (on-behalf-of / OBO)
#      - Forwarded via X-Forwarded-Access-Token header when opened from Compute → Apps
#      - Used for: SQL warehouse queries, model serving, Genie conversations, dashboard listing
#      - Requires user_api_scopes below; user must consent on first visit
#
# APP RESOURCES: User-facing resources the app accesses (SQL warehouse, serving endpoints, Genie, UC volume).
# Jobs (1–7) are admin/setup resources discovered via ws.jobs.list() using inherited workspace permissions.
# Pipelines are also discovered dynamically; not a supported app resource type.
#
# Note: vector_search_index, UC functions, and experiments are not supported as app resource types.
# Add them manually in Workspace → Apps → payment-analysis → Configure → App resources if needed.
# =============================================================================

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: >-
        Payment Approval Rate Optimization Platform — 8 AI agents, 4 ML models,
        3 AI/BI dashboards, 26 gold views, closed-loop decisioning engine,
        and full-stack React + FastAPI control center for Getnet.

      # -----------------------------------------------------------------------
      # User authorization scopes (OAuth consent)
      # -----------------------------------------------------------------------
      # Users must consent to these scopes on first visit (Compute → Apps → payment-analysis).
      # Each scope enables the app to call Databricks APIs using the user's identity (OBO).
      # Invalid scopes cause "error while trying to authenticate" at login.
      # See: https://docs.databricks.com/en/dev-tools/databricks-apps/auth.html
      #
      # Required by this app:
      #   sql                        → SQL warehouse queries (analytics, gold views, KPIs)
      #   serving.serving-endpoints  → Model Serving (4 ML endpoints + ResponsesAgent)
      #   dashboards.genie           → Genie Conversation API (natural-language data queries)
      #   (dashboards.lakeview is NOT a valid app scope — dashboard listing uses the user's OBO token directly)
      user_api_scopes:
        - sql
        - serving.serving-endpoints
        - dashboards.genie

      # -----------------------------------------------------------------------
      # App resources (SP permissions on workspace resources)
      # -----------------------------------------------------------------------
      # These bindings grant the app's service principal access to specific resources.
      # Platform injects DATABRICKS_WAREHOUSE_ID from the sql-warehouse binding.
      resources:
        # SQL Warehouse — [dev] Payment Analysis Warehouse
        # Used by: DatabricksService.execute_query() for all analytics, KPIs, gold views, app_config
        - name: sql-warehouse
          description: SQL warehouse for analytics queries, gold views, and app_config
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE

        # UC Volume — /Volumes/<catalog>/<schema>/reports
        # Used by: Genie config sync, report storage
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME

        # Genie Space — Payment Analytics
        # Used by: POST /api/agents/chat → ws.genie.start_conversation_and_wait()
        - name: genie-space
          description: Genie space for natural-language data queries (Genie Assistant floating dialog)
          genie_space:
            name: "Payment Analytics"
            space_id: ${var.genie_space_id}
            permission: CAN_EDIT

        # ResponsesAgent — AI Chat primary backend (Path 1)
        # PaymentAnalysisAgent with 10 UC tools + python_exec
        # Used by: POST /api/agents/orchestrator/chat
        - name: serving-response-agent
          serving_endpoint: { name: "payment-response-agent", permission: CAN_QUERY }

        # ML Model Serving endpoints (4 models)
        # Used by: DecisionEngine parallel enrichment, ML predictions UI, /api/decision/ml/*
        - name: serving-approval-prop
          serving_endpoint: { name: "approval-propensity", permission: CAN_QUERY }
        - name: serving-risk-scoring
          serving_endpoint: { name: "risk-scoring", permission: CAN_QUERY }
        - name: serving-smart-routing
          serving_endpoint: { name: "smart-routing", permission: CAN_QUERY }
        - name: serving-smart-retry
          serving_endpoint: { name: "smart-retry", permission: CAN_QUERY }

        # ------------------------------------------------------------------------------------------
        # UC Functions (5 consolidated functions for ResponsesAgent)
        # NOTE: UC functions cannot be added via DAB uc_securable (only VOLUME is supported).
        # They must be added manually via Apps UI or Apps API after deployment.
        # These 5 functions are used by the ResponsesAgent (payment-response-agent).
        #
        # To add via UI: Compute → Apps → payment-analysis → Configure → App resources
        #   → Add resource → Unity Catalog function
        #   For each function:
        #     - Securable type: FUNCTION
        #     - Securable full name: ahs_demos_catalog.payment_analysis.<function_name>
        #     - Permission: EXECUTE
        #
        # Functions to add:
        #   1. analyze_declines
        #   2. analyze_performance
        #   3. analyze_retry
        #   4. analyze_risk
        #   5. analyze_routing
        #
        # Additional UC Functions (individual, not consolidated):
        #   get_cascade_recommendations, get_decline_by_segment, get_decline_trends,
        #   get_high_risk_transactions, get_kpi_summary, get_optimization_opportunities,
        #   get_recovery_opportunities, get_retry_success_rates, get_risk_distribution,
        #   get_route_performance, get_trend_analysis, get_active_approval_rules,
        #   get_recent_incidents, search_similar_transactions, get_approval_recommendations,
        #   get_decision_outcomes
        #
        # Vector Search Index: similar_transactions_index — added manually or via script.
        #
        # Jobs (1–7): Admin/setup resources discovered via ws.jobs.list().
        # Pipelines (8–9): Not a supported app resource type.
        # Foundation Model Endpoints (AI Gateway): Available to all workspace users by default.
        # ------------------------------------------------------------------------------------------
