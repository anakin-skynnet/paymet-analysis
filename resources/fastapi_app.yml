# Databricks App resource: name, source path, and resource bindings.
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Full configuration: User authorization scopes (below) + App resources listed. Set --var genie_space_id=<uuid> for Genie when deploying.
#
# APP RESOURCES: Only user-facing resources are included (SQL warehouse, UC volume, ML serving endpoints).
# Jobs (1–7) are admin/setup resources and are NOT included — the app SP can discover them via
# ws.jobs.list() using inherited workspace permissions. See the comment section below for details.
#   If a deploy fails with "Endpoint with name '...' does not exist", run Job 5 (ML models) and
#   Job 6 (agents) first so the endpoints exist, then redeploy.
#   For orchestrator chat: ORCHESTRATOR_SERVING_ENDPOINT is set in app.yml (project root).
#
# Note: experiments, vector_search_index, and UC functions are not supported as app resource types
# by the bundle schema. Add them manually in Workspace → Apps → payment-analysis → Configure → App resources if needed.
# App env: defined in app.yml at project root (env section). LAKEBASE_*, PYTHONPATH, ORCHESTRATOR_SERVING_ENDPOINT.
# Platform-injected: DATABRICKS_WAREHOUSE_ID (from sql-warehouse binding), DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET.

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: Payment Approval Optimization Platform – dashboards, rules, decisioning, ML models, and agent jobs.
      # User authorization scopes (Users must consent; required for OBO access). See Apps UI → Configure → User authorization.
      # User authorization scopes — only include scopes supported by the workspace OAuth system.
      # Invalid scopes cause "error while trying to authenticate" at login.
      # See: https://docs.databricks.com/en/dev-tools/databricks-apps/auth.html
      user_api_scopes:
        - sql
        - serving.serving-endpoints
        - dashboards.genie
      resources:
        # SQL warehouse — [dev] Payment Analysis Warehouse
        - name: sql-warehouse
          description: SQL warehouse for analytics, app_config, gold views
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE
        # UC volume — /Volumes/ahs_demos_catalog/payment_analysis/reports
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME
        # Genie space — Payment Analytics (natural-language data queries).
        # Grants the app SP CAN_EDIT on the Genie space for the Genie Assistant dialog.
        - name: genie-space
          description: Genie space Payment Analytics
          genie_space:
            name: "Payment Analytics"
            space_id: ${var.genie_space_id}
            permission: CAN_EDIT
        # ResponsesAgent endpoint — the AI Chat's primary backend (Path 1).
        # PaymentAnalysisAgent (agent.py) with 10 UC tools + python_exec.
        - name: serving-response-agent
          serving_endpoint: { name: "payment-response-agent", permission: CAN_QUERY }
        # ML Model Serving endpoints (4 models — used by DecisionEngine and ML predictions UI)
        - name: serving-approval-prop
          serving_endpoint: { name: "approval-propensity", permission: CAN_QUERY }
        - name: serving-risk-scoring
          serving_endpoint: { name: "risk-scoring", permission: CAN_QUERY }
        - name: serving-smart-routing
          serving_endpoint: { name: "smart-routing", permission: CAN_QUERY }
        - name: serving-smart-retry
          serving_endpoint: { name: "smart-retry", permission: CAN_QUERY }
        # ------------------------------------------------------------------------------------------
        # Jobs are NOT included as app resources. They are admin/setup resources, not user-facing.
        # The app's Setup & Run page uses ws.jobs.list() (inherited workspace permissions) to
        # discover and trigger jobs. End-users interacting with the app don't need direct job access;
        # they use dashboards, decisioning, ML predictions, and agent chat.
        # To grant the app SP access to jobs for Setup & Run, add CAN_MANAGE_RUN on each job via
        # Workspace → Jobs → [job] → Permissions → Add payment-analysis SP.
        # ------------------------------------------------------------------------------------------
        # ------------------------------------------------------------------------------------------
        # Pipelines: The backend uses ws.pipelines.list_pipelines() and ws.pipelines.start_update()
        # for pipelines 8 & 9 from the Setup & Run page. However, **pipelines are NOT a supported
        # Databricks Apps resource type**. To grant access:
        #   1. In Workspace → Pipelines → [pipeline] → Permissions, add the app's service principal
        #      (payment-analysis) with "Can Manage Run" permission. OR
        #   2. In the pipeline permissions section of pipelines.yml (DAB), add the app SP.
        # Pipeline IDs:
        #   8. ETL: ${resources.pipelines.payment_analysis_etl.id}
        #   9. Real-Time Stream: ${resources.pipelines.payment_realtime_pipeline.id}
        # ------------------------------------------------------------------------------------------
        # Optional: legacy/external LLM endpoint (uncomment if used)
        # - name: serving-endpoint
        #   description: External model endpoint
        #   serving_endpoint:
        #     name: "mas-b6e74e87-endpoint"
        #     permission: CAN_QUERY
        # --- Not supported by bundle schema; add in Workspace → Apps → Configure → App resources if needed ---
        # MLflow experiments (IDs are workspace-specific; add manually after deploy)
        # Vector search index: ${var.catalog}.${var.schema}.similar_transactions_index
        # UC functions: ${var.catalog}.${var.schema}.<function_name> (agent tools from Job 3)
