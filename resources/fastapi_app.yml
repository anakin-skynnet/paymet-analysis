# =============================================================================
# Databricks App Resource: Payment Analysis Platform
# =============================================================================
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = workspace root (sync destination).
#
# Two identity models:
#   1. APP AUTHORIZATION (service principal)
#      - Injected automatically: DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET
#      - Used for: Lakebase (managed Postgres), background tasks, app_config, session management
#      - The SP needs: Postgres role in Lakebase, UC permissions on catalog/schema
#
#   2. USER AUTHORIZATION (on-behalf-of / OBO)
#      - Forwarded via X-Forwarded-Access-Token header when opened from Compute → Apps
#      - Used for: SQL warehouse queries, model serving, Genie conversations, dashboard listing
#      - Requires user_api_scopes below; user must consent on first visit
#
# APP RESOURCES: User-facing resources the app accesses (SQL warehouse, serving endpoints, Genie, UC volume).
# Jobs (1–7) are admin/setup resources discovered via ws.jobs.list() using inherited workspace permissions.
# Pipelines are also discovered dynamically; not a supported app resource type.
#
# Note: vector_search_index, UC functions, and experiments are not supported as app resource types.
# Add them manually in Workspace → Apps → payment-analysis → Configure → App resources if needed.
# =============================================================================

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.root_path}
      description: >-
        Payment Approval Rate Optimization Platform — 8 AI agents, 4 ML models,
        3 AI/BI dashboards, 26 gold views, closed-loop decisioning engine,
        and full-stack React + FastAPI control center for Getnet.

      # -----------------------------------------------------------------------
      # User authorization scopes (OAuth consent)
      # -----------------------------------------------------------------------
      # Users must consent to these scopes on first visit (Compute → Apps → payment-analysis).
      # Each scope enables the app to call Databricks APIs using the user's identity (OBO).
      # Invalid scopes cause "error while trying to authenticate" at login.
      # See: https://docs.databricks.com/en/dev-tools/databricks-apps/auth.html
      #
      # Required by this app:
      #   sql                        → SQL warehouse queries (analytics, gold views, KPIs)
      #   serving.serving-endpoints  → Model Serving (4 ML endpoints + ResponsesAgent)
      #   dashboards.genie           → Genie Conversation API (natural-language data queries)
      #   (dashboards.lakeview is NOT a valid app scope — dashboard listing uses the user's OBO token directly)
      user_api_scopes:
        - sql
        - serving.serving-endpoints
        - dashboards.genie

      # -----------------------------------------------------------------------
      # App resources (SP permissions on workspace resources)
      # -----------------------------------------------------------------------
      # These bindings grant the app's service principal access to specific resources.
      # Platform injects DATABRICKS_WAREHOUSE_ID from the sql-warehouse binding.
      resources:
        # SQL Warehouse — [dev] Payment Analysis Warehouse
        # Used by: DatabricksService.execute_query() for all analytics, KPIs, gold views, app_config
        - name: sql-warehouse
          description: SQL warehouse for analytics queries, gold views, and app_config
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE

        # UC Volume — /Volumes/<catalog>/<schema>/reports
        # Used by: Genie config sync, report storage
        - name: volume-reports
          description: UC volume for reports and Genie config
          uc_securable:
            securable_type: VOLUME
            securable_full_name: "${var.catalog}.${var.schema}.reports"
            permission: READ_VOLUME

        # Genie Space — Payment Analytics
        # Used by: POST /api/agents/chat → ws.genie.start_conversation_and_wait()
        # NOTE: Temporarily commented out — Genie space gets auto-trashed when created
        # programmatically with minimal config. Create manually in Genie UI, then uncomment.
        # - name: genie-space
        #   description: Genie space for natural-language data queries (Genie Assistant floating dialog)
        #   genie_space:
        #     name: "Payment Analytics"
        #     space_id: ${var.genie_space_id}
        #     permission: CAN_EDIT

        # ResponsesAgent — AI Chat primary backend (Path 1)
        # PaymentAnalysisAgent with 10 UC tools + python_exec
        # Used by: POST /api/agents/orchestrator/chat
        - name: serving-response-agent
          serving_endpoint: { name: "payment-response-agent", permission: CAN_QUERY }

        # ML Model Serving endpoints (4 models)
        # Used by: DecisionEngine parallel enrichment, ML predictions UI, /api/decision/ml/*
        - name: serving-approval-prop
          serving_endpoint: { name: "approval-propensity", permission: CAN_QUERY }
        - name: serving-risk-scoring
          serving_endpoint: { name: "risk-scoring", permission: CAN_QUERY }
        - name: serving-smart-routing
          serving_endpoint: { name: "smart-routing", permission: CAN_QUERY }
        - name: serving-smart-retry
          serving_endpoint: { name: "smart-retry", permission: CAN_QUERY }

        # ------------------------------------------------------------------------------------------
        # NOT included as app resources (discovered dynamically or not supported):
        #
        # Jobs (1–7): Admin/setup resources. The app discovers them via ws.jobs.list() using
        #   inherited workspace permissions. To grant the SP access for Setup & Run, add
        #   CAN_MANAGE_RUN on each job via Workspace → Jobs → [job] → Permissions.
        #
        # Pipelines (8–9): Not a supported app resource type. Grant access via
        #   Workspace → Pipelines → [pipeline] → Permissions → Add payment-analysis SP
        #   with "Can Manage Run" permission.
        #
        # Vector Search: Index ${var.catalog}.${var.schema}.similar_transactions_index
        #   Not a supported app resource type. Used by DecisionEngine for experience replay.
        #
        # UC Functions: ${var.catalog}.${var.schema}.<function_name>
        #   Agent tools registered by Job 3. Not supported as app resource type.
        #
        # Foundation Model Endpoints (AI Gateway): databricks-claude-opus-4-6, databricks-claude-sonnet-4-5
        #   Accessed via ws.serving_endpoints.query(). Available to all workspace users by default.
        # ------------------------------------------------------------------------------------------
