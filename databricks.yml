# Databricks Asset Bundle Configuration
# Uses latest DAB features: presets, serverless, run_as, permissions
# Documentation: https://docs.databricks.com/dev-tools/bundles/

bundle:
  name: payment-analysis

# Workspace configuration with dynamic path
workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/getnet_approval_rates_v3

# Modular resource definitions
include:
  - resources/unity_catalog.yml
  - resources/pipelines.yml
  - resources/sql_warehouse.yml
  - resources/ml_jobs.yml
  - resources/ai_gateway.yml
  - resources/streaming_simulator.yml
  - resources/genie_spaces.yml
  # Enable after gold views exist (run DLT pipelines): uncomment and run scripts/substitute_dashboard_vars.py, then deploy with BUNDLE_VAR_warehouse_id set
  # - resources/dashboards.yml
  # Enable after ML models are trained (run ML job):
  # - resources/model_serving.yml

# Environment variables with validation
variables:
  catalog:
    description: Unity Catalog name for data storage
    default: ahs_demos_catalog
  environment:
    description: Deployment environment identifier
    default: dev
  warehouse_id:
    description: >
      SQL Warehouse ID for dashboard queries. Required for dashboard deploy.
      Get one with: databricks sql warehouses list -o json | jq -r '.[0].id'
      Then: export BUNDLE_VAR_warehouse_id=<id> and run scripts/substitute_dashboard_vars.py before deploy.
    default: "auto"
  schema:
    description: Unity Catalog schema name (matches DLT target with dev mode prefix)
    default: ahs_demo_payment_analysis_dev

# Sync configuration for notebook deployment
sync:
  include:
    - .build
    - src/payment_analysis/ml
    - src/payment_analysis/streaming
    - src/payment_analysis/transform
    - src/payment_analysis/agents
    - src/payment_analysis/genie
  exclude:
    - "**/__pycache__"
    - "**/*.pyc"
    - "**/node_modules"

# Build artifacts
artifacts:
  default:
    build: uv run apx build

# Target configurations
targets:
  # Development environment
  dev:
    mode: development
    default: true
    variables:
      environment: dev
    # Development presets for faster iteration
    presets:
      name_prefix: "[dev ${workspace.current_user.short_name}] "
      pipelines_development: true
      jobs_max_concurrent_runs: 1
      trigger_pause_status: PAUSED

  # Production environment  
  prod:
    mode: production
    variables:
      environment: prod
      catalog: prod_catalog
    # Production presets with permissions
    presets:
      name_prefix: "[PROD] "
      pipelines_development: false
    # Run as service principal in production
    run_as:
      service_principal_name: payment-analysis-sp
    # Default permissions for all resources
    permissions:
      - level: CAN_VIEW
        group_name: data-analysts
      - level: CAN_MANAGE
        group_name: data-engineers
