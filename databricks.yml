# Databricks Asset Bundle Configuration
# Uses latest DAB features: presets, serverless, run_as, permissions
# Documentation: https://docs.databricks.com/dev-tools/bundles/

bundle:
  name: payment-analysis

# Workspace configuration with dynamic path
workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/getnet_approval_rates_v2

# Modular resource definitions
include:
  - resources/unity_catalog.yml
  - resources/pipelines.yml
  - resources/sql_warehouse.yml
  - resources/ml_jobs.yml
  - resources/ai_gateway.yml
  - resources/streaming_simulator.yml
  - resources/genie_spaces.yml
  # Enable dashboards after views are created and data exists:
  # - resources/dashboards.yml
  # Enable after tables exist:
  # - resources/model_serving.yml

# Environment variables with validation
variables:
  catalog:
    description: Unity Catalog name for data storage
    default: main
  environment:
    description: Deployment environment identifier
    default: dev
  warehouse_id:
    description: SQL Warehouse ID for queries (optional)
    default: "3fef3d3419b56344"

# Sync configuration for notebook deployment
sync:
  include:
    - .build
    - src/payment_analysis/ml
    - src/payment_analysis/streaming
    - src/payment_analysis/transform
    - src/payment_analysis/agents
    - src/payment_analysis/genie
  exclude:
    - "**/__pycache__"
    - "**/*.pyc"
    - "**/node_modules"

# Build artifacts
artifacts:
  default:
    build: uv run apx build

# Target configurations
targets:
  # Development environment
  dev:
    mode: development
    default: true
    variables:
      environment: dev
    # Development presets for faster iteration
    presets:
      name_prefix: "[dev ${workspace.current_user.short_name}] "
      pipelines_development: true
      jobs_max_concurrent_runs: 1
      trigger_pause_status: PAUSED

  # Production environment  
  prod:
    mode: production
    variables:
      environment: prod
      catalog: prod_catalog
    # Production presets with permissions
    presets:
      name_prefix: "[PROD] "
      pipelines_development: false
    # Run as service principal in production
    run_as:
      service_principal_name: payment-analysis-sp
    # Default permissions for all resources
    permissions:
      - level: CAN_VIEW
        group_name: data-analysts
      - level: CAN_MANAGE
        group_name: data-engineers
