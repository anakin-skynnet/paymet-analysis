# =============================================================================
# Databricks Asset Bundle (DAB) - Payment Analysis Platform
# =============================================================================
# This project is a Databricks Asset Bundle per the official docs:
#   https://docs.databricks.com/aws/en/dev-tools/bundles/
# Payment approval optimization: Smart Checkout, Reason Codes, Smart Retry.
# All parameters have defaults or are set at deployment (target/variables).
# Docs: docs/ARCHITECTURE_REFERENCE.md
# =============================================================================

bundle:
  name: payment-analysis

# Workspace root for notebooks, jobs, and dashboards (user-scoped).
# file_path is where bundle sync uploads files; app source_code_path must match so the app finds src/payment_analysis/__dist__ (apx/cookbook: run from synced folder).
workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/${var.workspace_folder}
  file_path: /Workspace/Users/${workspace.current_user.userName}/${var.workspace_folder}/files

# Resource modules. Order: UC → warehouse → pipelines → jobs → dashboards → app.
# Lakebase is required for UI CRUD (rules, experiments, incidents) and ML features.
# model_serving.yml — uncomment after Step 5 (Train ML Models) so 4 models exist in UC.
# Vector Search: create manually from resources/vector_search.yml.
# Execution order for jobs (Setup & Run): see docs/DEPLOYMENT_GUIDE.md and Setup & Run in the app.
include:
  - resources/unity_catalog.yml
  - resources/lakebase.yml
  - resources/pipelines.yml
  - resources/sql_warehouse.yml
  - resources/ml_jobs.yml
  - resources/agents.yml
  - resources/streaming_simulator.yml
  - resources/genie_spaces.yml
  - resources/dashboards.yml
  # - resources/model_serving.yml  # Uncomment after Step 5 (Train ML Models) so 4 models exist in UC
  - resources/fastapi_app.yml

# -----------------------------------------------------------------------------
# Bundle variables (override via --var, BUNDLE_VAR_*, or target variables)
# -----------------------------------------------------------------------------
variables:
  catalog:
    description: Unity Catalog name for all data, volumes, and ML models
    default: ahs_demos_catalog
  environment:
    description: Deployment environment identifier (e.g. dev, prod); used in resource names and tags
    default: dev
  schema:
    description: Unity Catalog schema name; must match Lakeflow outputs and gold views
    default: payment_analysis
  warehouse_id:
    description: SQL Warehouse ID for dashboards and SQL tasks; in dev, set from deployed warehouse resource
    default: "148ccb90800933a1"
  # Lakebase (managed Postgres) - required for UI CRUD and ML features; app uses PGAPPNAME = lakebase_instance_name
  lakebase_instance_name:
    description: Lakebase database instance name (PGAPPNAME in app); must be unique per workspace
    default: payment-analysis-db
  lakebase_capacity:
    description: Lakebase instance capacity (CU_1, CU_2, CU_4, CU_8)
    default: CU_1
  lakebase_uc_catalog_name:
    description: Unity Catalog catalog name for Lakebase registration
    default: payment_analysis_lakebase
  lakebase_database_name:
    description: Postgres database name inside the Lakebase instance
    default: payment_analysis
  workspace_folder:
    description: Workspace folder name for bundle files (notebooks, dashboards, app). Must match repo/deploy path (e.g. payment-analysis).
    default: payment-analysis
  # Genie space ID for app resource binding. Default empty; do not add genie-space to app resources in resources/fastapi_app.yml unless this is set (empty space_id causes deploy to fail).
  genie_space_id:
    description: "Genie space ID (e.g. UUID of 'Approvals domain expert' from Genie UI). Set when uncommenting genie-space in resources/fastapi_app.yml."
    default: ""

# -----------------------------------------------------------------------------
# Sync: paths uploaded to workspace for job/pipeline execution and app
# -----------------------------------------------------------------------------
sync:
  include:
    - .build
    - src/payment_analysis/__dist__   # UI build output (created by artifacts.default build); required for app web UI
    - src/payment_analysis/ml
    - src/payment_analysis/streaming
    - src/payment_analysis/transform
    - src/payment_analysis/agents
    - src/payment_analysis/genie
    - src/payment_analysis/vector_search
    - scripts
    - resources/dashboards
  exclude:
    - "**/__pycache__"
    - "**/*.pyc"
    - "**/node_modules"
    - "**/.env"
    - "**/.env.*"

# Build artifact for app deployment (served at /)
artifacts:
  default:
    build: uv run apx build

# -----------------------------------------------------------------------------
# Targets: dev (development) and prod (production)
# -----------------------------------------------------------------------------
targets:
  dev:
    mode: development
    default: true
    variables:
      environment: dev
      warehouse_id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
      # Unique DNS-compliant name (alphanumeric and hyphens only); override with --var if needed
      lakebase_instance_name: payment-analysis-db-dev
    presets:
      name_prefix: "[dev ${workspace.current_user.short_name}] "
      pipelines_development: true
      jobs_max_concurrent_runs: 1
      trigger_pause_status: PAUSED

  prod:
    mode: production
    variables:
      environment: prod
      catalog: prod_catalog
      schema: ahs_demo_payment_analysis_prod
      warehouse_id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
    presets:
      name_prefix: "[PROD] "
      pipelines_development: false
    run_as:
      service_principal_name: payment-analysis-sp
    permissions:
      - level: CAN_VIEW
        group_name: data-analysts
      - level: CAN_MANAGE
        group_name: data-engineers
