# =============================================================================
# Databricks Asset Bundle - Payment Analysis Platform
# =============================================================================
# Payment approval optimization: Smart Checkout, Reason Codes, Smart Retry.
# All parameters have defaults or are set at deployment (target/variables).
# Docs: docs/4_TECHNICAL.md
# =============================================================================

bundle:
  name: payment-analysis

# Workspace root for notebooks, jobs, and dashboards (user-scoped)
workspace:
  root_path: /Workspace/Users/${workspace.current_user.userName}/${var.workspace_folder}

# Resource modules. Order: UC/Lakebase → warehouse → pipelines → jobs → dashboards → app.
# Expected: unity_catalog, lakebase, pipelines, sql_warehouse, ml_jobs, agents, ai_gateway,
#           streaming_simulator, genie_spaces, dashboards, model_serving, app.
# Vector Search (vector_search.yml): not in bundle schema; create endpoint/index manually from that spec.
include:
  - resources/unity_catalog.yml
  - resources/lakebase.yml
  - resources/pipelines.yml
  - resources/sql_warehouse.yml
  - resources/ml_jobs.yml
  - resources/agents.yml
  - resources/ai_gateway.yml
  - resources/streaming_simulator.yml
  - resources/genie_spaces.yml
  - resources/dashboards.yml
  - resources/model_serving.yml
  - resources/app.yml

# -----------------------------------------------------------------------------
# Bundle variables (override via --var, BUNDLE_VAR_*, or target variables)
# -----------------------------------------------------------------------------
variables:
  catalog:
    description: Unity Catalog name for all data, volumes, and ML models
    default: ahs_demos_catalog
  environment:
    description: Deployment environment identifier (e.g. dev, prod); used in resource names and tags
    default: dev
  schema:
    description: Unity Catalog schema name; must match Lakeflow outputs and gold views
    default: ahs_demo_payment_analysis_dev
  warehouse_id:
    description: SQL Warehouse ID for dashboards and SQL tasks; in dev, set from deployed warehouse resource
    default: "auto"
  # Lakebase (managed Postgres) - optional; app uses PGAPPNAME = lakebase_instance_name
  lakebase_instance_name:
    description: Lakebase database instance name (PGAPPNAME in app)
    default: payment-analysis-db
  lakebase_capacity:
    description: Lakebase instance capacity (CU_1, CU_2, CU_4, CU_8)
    default: CU_1
  lakebase_uc_catalog_name:
    description: Unity Catalog catalog name for Lakebase registration
    default: payment_analysis_lakebase
  lakebase_database_name:
    description: Postgres database name inside the Lakebase instance
    default: payment_analysis
  workspace_folder:
    description: Workspace folder name for bundle files (notebooks, dashboards, app)
    default: payment-analysis

# -----------------------------------------------------------------------------
# Sync: paths uploaded to workspace for job/pipeline execution
# -----------------------------------------------------------------------------
sync:
  include:
    - .build
    - src/payment_analysis/ml
    - src/payment_analysis/streaming
    - src/payment_analysis/transform
    - src/payment_analysis/agents
    - src/payment_analysis/genie
  exclude:
    - "**/__pycache__"
    - "**/*.pyc"
    - "**/node_modules"
    - "**/.env"
    - "**/.env.*"

# Build artifact for app deployment (served at /)
artifacts:
  default:
    build: uv run apx build

# -----------------------------------------------------------------------------
# Targets: dev (development) and prod (production)
# -----------------------------------------------------------------------------
targets:
  dev:
    mode: development
    default: true
    variables:
      environment: dev
      warehouse_id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
    presets:
      name_prefix: "[dev ${workspace.current_user.short_name}] "
      pipelines_development: true
      jobs_max_concurrent_runs: 1
      trigger_pause_status: PAUSED

  prod:
    mode: production
    variables:
      environment: prod
      catalog: prod_catalog
      schema: ahs_demo_payment_analysis_prod
      warehouse_id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
    presets:
      name_prefix: "[PROD] "
      pipelines_development: false
    run_as:
      service_principal_name: payment-analysis-sp
    permissions:
      - level: CAN_VIEW
        group_name: data-analysts
      - level: CAN_MANAGE
        group_name: data-engineers
